name: Update data.js with current week

on:
  push:
    paths:
      - 'current-week.js'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Append or update current week in data.js
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          const CUTOFF_HOUR = 17;
          const CUTOFF_DAY = 5;
          
          // Default dates (used only for NEW organizations)
          const DEFAULT_START_DATE = '2026-01-02';
          const DEFAULT_TARGET_DATE = '2026-04-03';
          
          // Read current-week.js
          const currentWeekContent = fs.readFileSync('current-week.js', 'utf8');
          let CURRENT_WEEK_DATA;
          try {
            const wrappedCode = currentWeekContent + '\nCURRENT_WEEK_DATA;';
            CURRENT_WEEK_DATA = eval(wrappedCode);
          } catch (error) {
            console.log('ERROR parsing current-week.js:', error.message);
            process.exit(1);
          }
          
          // Read existing data.js and PRESERVE everything
          let ORG_DATA = {};
          let ORG_DATA_CMMC = {};
          let ORG_DATA_NONCMMC = {};
          
          try {
            const dataContent = fs.readFileSync('data.js', 'utf8');
            eval(dataContent);
            console.log('Successfully loaded existing data.js');
            console.log('ORG_DATA has ' + Object.keys(ORG_DATA).length + ' organizations');
            console.log('ORG_DATA_CMMC has ' + Object.keys(ORG_DATA_CMMC).length + ' organizations');
            console.log('ORG_DATA_NONCMMC has ' + Object.keys(ORG_DATA_NONCMMC).length + ' organizations');
          } catch (error) {
            console.log('WARNING: Could not read existing data.js, initializing new structure');
          }
          
          function getTargetWeekDate(nowDate) {
            const date = new Date(nowDate);
            const dayOfWeek = date.getUTCDay();
            const hour = date.getUTCHours();
            
            if (dayOfWeek === CUTOFF_DAY && hour >= CUTOFF_HOUR) {
              const nextFriday = new Date(date);
              nextFriday.setUTCDate(date.getUTCDate() + 7);
              return nextFriday.toISOString().split('T')[0];
            }
            
            let daysUntilFriday = (CUTOFF_DAY - dayOfWeek + 7) % 7;
            if (daysUntilFriday === 0 && dayOfWeek === CUTOFF_DAY) {
              daysUntilFriday = 0;
            }
            
            const thisFriday = new Date(date);
            thisFriday.setUTCDate(date.getUTCDate() + daysUntilFriday);
            return thisFriday.toISOString().split('T')[0];
          }
          
          function updateDataset(dataset, currentData, datasetName) {
            if (!currentData) {
              console.log('WARNING: No data for ' + datasetName);
              return;
            }
            
            // Process each organization in the current data
            for (const orgName in currentData) {
              if (!dataset[orgName]) {
                // New organization - use defaults
                dataset[orgName] = {
                  startDate: DEFAULT_START_DATE,
                  targetDate: DEFAULT_TARGET_DATE,
                  weeklyProgress: []
                };
                console.log('Initialized ' + datasetName + ' / ' + orgName + ' with default dates');
              }
              
              // PRESERVE existing startDate and targetDate
              // If they don't exist, use defaults
              if (!dataset[orgName].startDate) {
                dataset[orgName].startDate = DEFAULT_START_DATE;
              }
              if (!dataset[orgName].targetDate) {
                dataset[orgName].targetDate = DEFAULT_TARGET_DATE;
              }
              
              // PRESERVE existing weeklyProgress array
              if (!dataset[orgName].weeklyProgress) {
                dataset[orgName].weeklyProgress = [];
              }
              
              // Find if this week already exists
              const weekIndex = dataset[orgName].weeklyProgress.findIndex(w => w.date === targetWeek);
              
              const newWeekData = {
                date: targetWeek,
                totalApplications: currentData[orgName].totalApplications || 0,
                missingMandatory: currentData[orgName].missingMandatory || 0,
                missingQuality: currentData[orgName].missingQuality || 0,
                missingApprovals: currentData[orgName].missingApprovals || 0,
                missingSurveys: currentData[orgName].missingSurveys || 0
              };
              
              if (weekIndex !== -1) {
                // Update existing week
                dataset[orgName].weeklyProgress[weekIndex] = newWeekData;
                console.log('UPDATED: ' + datasetName + ' / ' + orgName + ' week ' + targetWeek);
              } else {
                // Add new week
                dataset[orgName].weeklyProgress.push(newWeekData);
                console.log('ADDED: ' + datasetName + ' / ' + orgName + ' week ' + targetWeek);
              }
              
              // Sort by date
              dataset[orgName].weeklyProgress.sort((a, b) => 
                new Date(a.date) - new Date(b.date)
              );
            }
          }
          
          const now = new Date();
          const targetWeek = getTargetWeekDate(now);
          
          console.log('================================================');
          console.log('Current UTC time: ' + now.toISOString());
          console.log('Target week date: ' + targetWeek);
          console.log('Default start date: ' + DEFAULT_START_DATE);
          console.log('Default target date: ' + DEFAULT_TARGET_DATE);
          console.log('Cutoff: Friday at ' + CUTOFF_HOUR + ':00 UTC');
          console.log('================================================');
          
          updateDataset(ORG_DATA, CURRENT_WEEK_DATA.all, 'All Applications');
          updateDataset(ORG_DATA_CMMC, CURRENT_WEEK_DATA.cmmc, 'CMMC Applications');
          updateDataset(ORG_DATA_NONCMMC, CURRENT_WEEK_DATA.noncmmc, 'Non-CMMC Applications');
          
          // Format output with single quotes
          function formatJS(obj, indent = 4) {
            const spaces = ' '.repeat(indent);
            let result = '{\n';
            
            const keys = Object.keys(obj).sort();
            keys.forEach((key, index) => {
              result += spaces + "'" + key + "': {\n";
              result += spaces + '    startDate: \'' + obj[key].startDate + '\',\n';
              result += spaces + '    targetDate: \'' + obj[key].targetDate + '\',\n';
              result += spaces + '    weeklyProgress: [\n';
              
              obj[key].weeklyProgress.forEach((week, wIndex) => {
                result += spaces + '        {\n';
                result += spaces + '            date: \'' + week.date + '\',\n';
                result += spaces + '            totalApplications: ' + week.totalApplications + ',\n';
                result += spaces + '            missingMandatory: ' + week.missingMandatory + ',\n';
                result += spaces + '            missingQuality: ' + week.missingQuality + ',\n';
                result += spaces + '            missingApprovals: ' + week.missingApprovals + ',\n';
                result += spaces + '            missingSurveys: ' + week.missingSurveys + '\n';
                result += spaces + '        }';
                if (wIndex < obj[key].weeklyProgress.length - 1) result += ',';
                result += '\n';
              });
              
              result += spaces + '    ]\n';
              result += spaces + '}';
              if (index < keys.length - 1) result += ',';
              result += '\n';
            });
            
            result += '}';
            return result;
          }
          
          const timestamp = now.toISOString();
          
          let output = '// Application Completion Tracking Data\n';
          output += '// Last updated: ' + timestamp + '\n';
          output += '// Target week: ' + targetWeek + '\n';
          output += '// Cutoff: Friday at ' + CUTOFF_HOUR + ':00 UTC\n\n';
          output += '// All Applications (CMMC + Non-CMMC)\n';
          output += 'const ORG_DATA = ' + formatJS(ORG_DATA) + ';\n\n';
          output += '// CMMC Applications Data\n';
          output += 'const ORG_DATA_CMMC = ' + formatJS(ORG_DATA_CMMC) + ';\n\n';
          output += '// Non-CMMC Applications Data\n';
          output += 'const ORG_DATA_NONCMMC = ' + formatJS(ORG_DATA_NONCMMC) + ';\n';
          
          fs.writeFileSync('data.js', output, 'utf8');
          
          console.log('================================================');
          console.log('SUCCESS: data.js updated successfully');
          console.log('All organizations preserved: ' + Object.keys(ORG_DATA).length + ' (All)');
          console.log('All organizations preserved: ' + Object.keys(ORG_DATA_CMMC).length + ' (CMMC)');
          console.log('All organizations preserved: ' + Object.keys(ORG_DATA_NONCMMC).length + ' (Non-CMMC)');
          console.log('================================================');
          EOF
          
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data.js
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "Auto-update data.js - $TIMESTAMP"
            git push
            echo "Changes committed and pushed"
          fi
