name: Update data.js with current week

on:
  push:
    paths:
      - 'current-week.js'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Append or update current week in data.js
        run: |
          node << 'EOF'
          const fs = require('fs');
          const vm = require('vm');
          
          const CUTOFF_HOUR = 17;
          const CUTOFF_DAY = 5;
          
          // Read and execute current-week.js in a proper context
          const currentWeekContent = fs.readFileSync('current-week.js', 'utf8');
          const currentWeekContext = {};
          vm.createContext(currentWeekContext);
          vm.runInContext(currentWeekContent, currentWeekContext);
          const CURRENT_WEEK_DATA = currentWeekContext.CURRENT_WEEK_DATA;
          
          // Read and execute data.js in a proper context
          const dataContent = fs.readFileSync('data.js', 'utf8');
          const dataContext = {};
          vm.createContext(dataContext);
          vm.runInContext(dataContent, dataContext);
          let ORG_DATA = dataContext.ORG_DATA;
          let ORG_DATA_CMMC = dataContext.ORG_DATA_CMMC;
          let ORG_DATA_NONCMMC = dataContext.ORG_DATA_NONCMMC;
          
          function getTargetWeekDate(nowDate) {
            const date = new Date(nowDate);
            const dayOfWeek = date.getUTCDay();
            const hour = date.getUTCHours();
            
            if (dayOfWeek === CUTOFF_DAY && hour >= CUTOFF_HOUR) {
              const nextFriday = new Date(date);
              nextFriday.setUTCDate(date.getUTCDate() + 7);
              return nextFriday.toISOString().split('T')[0];
            }
            
            let daysUntilFriday = (CUTOFF_DAY - dayOfWeek + 7) % 7;
            
            if (daysUntilFriday === 0 && dayOfWeek === CUTOFF_DAY) {
              daysUntilFriday = 0;
            }
            
            const thisFriday = new Date(date);
            thisFriday.setUTCDate(date.getUTCDate() + daysUntilFriday);
            return thisFriday.toISOString().split('T')[0];
          }
          
          function updateWeekData(dataset, currentData, datasetName) {
            if (!dataset || !dataset['All'] || !dataset['All'].weeklyProgress) {
              console.log('WARNING: ' + datasetName + ' dataset structure invalid, skipping');
              return;
            }
            
            if (!currentData) {
              console.log('WARNING: ' + datasetName + ' no current week data found, skipping');
              return;
            }
            
            const weekIndex = dataset['All'].weeklyProgress.findIndex(w => w.date === targetWeek);
            
            const newWeekData = {
              date: targetWeek,
              totalApplications: currentData.totalApplications || 0,
              missingMandatory: currentData.missingMandatory || 0,
              missingQuality: currentData.missingQuality || 0,
              missingApprovals: currentData.missingApprovals || 0,
              missingSurveys: currentData.missingSurveys || 0
            };
            
            if (weekIndex !== -1) {
              dataset['All'].weeklyProgress[weekIndex] = newWeekData;
              console.log('UPDATED: ' + datasetName + ' week ' + targetWeek);
            } else {
              dataset['All'].weeklyProgress.push(newWeekData);
              console.log('ADDED: ' + datasetName + ' week ' + targetWeek);
            }
            
            dataset['All'].weeklyProgress.sort((a, b) => 
              new Date(a.date) - new Date(b.date)
            );
          }
          
          const now = new Date();
          const targetWeek = getTargetWeekDate(now);
          
          console.log('================================================');
          console.log('Current UTC time: ' + now.toISOString());
          console.log('Target week date: ' + targetWeek);
          console.log('Cutoff: Friday at ' + CUTOFF_HOUR + ':00 UTC');
          console.log('================================================');
          
          if (CURRENT_WEEK_DATA && CURRENT_WEEK_DATA.all && CURRENT_WEEK_DATA.all['All']) {
            updateWeekData(ORG_DATA, CURRENT_WEEK_DATA.all['All'], 'All Applications');
          } else {
            console.log('WARNING: All Applications - No data in current-week.js');
          }
          
          if (CURRENT_WEEK_DATA && CURRENT_WEEK_DATA.cmmc && CURRENT_WEEK_DATA.cmmc['All']) {
            if (typeof ORG_DATA_CMMC !== 'undefined') {
              updateWeekData(ORG_DATA_CMMC, CURRENT_WEEK_DATA.cmmc['All'], 'CMMC Applications');
            } else {
              console.log('WARNING: CMMC Applications - ORG_DATA_CMMC not defined in data.js');
            }
          } else {
            console.log('WARNING: CMMC Applications - No data in current-week.js');
          }
          
          if (CURRENT_WEEK_DATA && CURRENT_WEEK_DATA.noncmmc && CURRENT_WEEK_DATA.noncmmc['All']) {
            if (typeof ORG_DATA_NONCMMC !== 'undefined') {
              updateWeekData(ORG_DATA_NONCMMC, CURRENT_WEEK_DATA.noncmmc['All'], 'Non-CMMC Applications');
            } else {
              console.log('WARNING: Non-CMMC Applications - ORG_DATA_NONCMMC not defined in data.js');
            }
          } else {
            console.log('WARNING: Non-CMMC Applications - No data in current-week.js');
          }
          
          const timestamp = now.toISOString();
          
          let output = '// Application Completion Tracking Data\n';
          output += '// Last updated: ' + timestamp + '\n';
          output += '// Target week: ' + targetWeek + '\n';
          output += '// Cutoff: Friday at ' + CUTOFF_HOUR + ':00 UTC\n\n';
          output += '// All Applications (CMMC + Non-CMMC)\n';
          output += 'const ORG_DATA = ' + JSON.stringify(ORG_DATA, null, 4) + ';\n';
          
          if (typeof ORG_DATA_CMMC !== 'undefined') {
            output += '\n// CMMC Applications Data\n';
            output += 'const ORG_DATA_CMMC = ' + JSON.stringify(ORG_DATA_CMMC, null, 4) + ';\n';
          }
          
          if (typeof ORG_DATA_NONCMMC !== 'undefined') {
            output += '\n// Non-CMMC Applications Data\n';
            output += 'const ORG_DATA_NONCMMC = ' + JSON.stringify(ORG_DATA_NONCMMC, null, 4) + ';\n';
          }
          
          fs.writeFileSync('data.js', output, 'utf8');
          
          console.log('================================================');
          console.log('SUCCESS: data.js updated successfully');
          console.log('================================================');
          EOF
          
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data.js
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "Auto-update data.js - $TIMESTAMP"
            git push
            echo "Changes committed and pushed"
          fi
