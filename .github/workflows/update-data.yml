name: Update data.js with current week

on:
  push:
    paths:
      - 'current-week.js'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Append or update current week in data.js
        run: |
          node << 'EOF'
          const fs = require('fs');
          
          const CUTOFF_HOUR = 17;
          const CUTOFF_DAY = 5;
          
          // Read current-week.js and extract CURRENT_WEEK_DATA
          const currentWeekContent = fs.readFileSync('current-week.js', 'utf8');
          
          // Use eval in a safer way by wrapping in a function
          let CURRENT_WEEK_DATA;
          try {
            const wrappedCode = currentWeekContent + '\nCURRENT_WEEK_DATA;';
            CURRENT_WEEK_DATA = eval(wrappedCode);
          } catch (error) {
            console.log('ERROR parsing current-week.js:', error.message);
            process.exit(1);
          }
          
          console.log('================================================');
          console.log('PARSED CURRENT_WEEK_DATA:');
          console.log(JSON.stringify(CURRENT_WEEK_DATA, null, 2));
          console.log('================================================');
          
          // Read and execute data.js with error handling
          let ORG_DATA, ORG_DATA_CMMC, ORG_DATA_NONCMMC;
          
          try {
            const dataContent = fs.readFileSync('data.js', 'utf8');
            eval(dataContent);
          } catch (error) {
            console.log('WARNING: Could not read existing data.js, initializing new structure');
          }
          
          // Initialize if undefined
          if (!ORG_DATA || typeof ORG_DATA !== 'object') {
            console.log('Initializing ORG_DATA');
            ORG_DATA = {
              "All": {
                "weeklyProgress": []
              }
            };
          }
          
          if (!ORG_DATA_CMMC || typeof ORG_DATA_CMMC !== 'object') {
            console.log('Initializing ORG_DATA_CMMC');
            ORG_DATA_CMMC = {
              "All": {
                "weeklyProgress": []
              }
            };
          }
          
          if (!ORG_DATA_NONCMMC || typeof ORG_DATA_NONCMMC !== 'object') {
            console.log('Initializing ORG_DATA_NONCMMC');
            ORG_DATA_NONCMMC = {
              "All": {
                "weeklyProgress": []
              }
            };
          }
          
          function getTargetWeekDate(nowDate) {
            const date = new Date(nowDate);
            const dayOfWeek = date.getUTCDay();
            const hour = date.getUTCHours();
            
            if (dayOfWeek === CUTOFF_DAY && hour >= CUTOFF_HOUR) {
              const nextFriday = new Date(date);
              nextFriday.setUTCDate(date.getUTCDate() + 7);
              return nextFriday.toISOString().split('T')[0];
            }
            
            let daysUntilFriday = (CUTOFF_DAY - dayOfWeek + 7) % 7;
            
            if (daysUntilFriday === 0 && dayOfWeek === CUTOFF_DAY) {
              daysUntilFriday = 0;
            }
            
            const thisFriday = new Date(date);
            thisFriday.setUTCDate(date.getUTCDate() + daysUntilFriday);
            return thisFriday.toISOString().split('T')[0];
          }
          
          function updateWeekData(dataset, currentData, datasetName) {
            if (!dataset || !dataset['All'] || !dataset['All'].weeklyProgress) {
              console.log('WARNING: ' + datasetName + ' dataset structure invalid, skipping');
              return;
            }
            
            if (!currentData) {
              console.log('WARNING: ' + datasetName + ' no current week data found, skipping');
              return;
            }
            
            const weekIndex = dataset['All'].weeklyProgress.findIndex(w => w.date === targetWeek);
            
            const newWeekData = {
              date: targetWeek,
              totalApplications: currentData.totalApplications || 0,
              missingMandatory: currentData.missingMandatory || 0,
              missingQuality: currentData.missingQuality || 0,
              missingApprovals: currentData.missingApprovals || 0,
              missingSurveys: currentData.missingSurveys || 0
            };
            
            if (weekIndex !== -1) {
              dataset['All'].weeklyProgress[weekIndex] = newWeekData;
              console.log('UPDATED: ' + datasetName + ' week ' + targetWeek);
            } else {
              dataset['All'].weeklyProgress.push(newWeekData);
              console.log('ADDED: ' + datasetName + ' week ' + targetWeek);
            }
            
            dataset['All'].weeklyProgress.sort((a, b) => 
              new Date(a.date) - new Date(b.date)
            );
          }
          
          const now = new Date();
          const targetWeek = getTargetWeekDate(now);
          
          console.log('================================================');
          console.log('Current UTC time: ' + now.toISOString());
          console.log('Target week date: ' + targetWeek);
          console.log('Cutoff: Friday at ' + CUTOFF_HOUR + ':00 UTC');
          console.log('================================================');
          
          if (CURRENT_WEEK_DATA && CURRENT_WEEK_DATA.all && CURRENT_WEEK_DATA.all['All']) {
            updateWeekData(ORG_DATA, CURRENT_WEEK_DATA.all['All'], 'All Applications');
          } else {
            console.log('WARNING: All Applications - No data in current-week.js');
          }
          
          if (CURRENT_WEEK_DATA && CURRENT_WEEK_DATA.cmmc && CURRENT_WEEK_DATA.cmmc['All']) {
            updateWeekData(ORG_DATA_CMMC, CURRENT_WEEK_DATA.cmmc['All'], 'CMMC Applications');
          } else {
            console.log('WARNING: CMMC Applications - No data in current-week.js');
          }
          
          if (CURRENT_WEEK_DATA && CURRENT_WEEK_DATA.noncmmc && CURRENT_WEEK_DATA.noncmmc['All']) {
            updateWeekData(ORG_DATA_NONCMMC, CURRENT_WEEK_DATA.noncmmc['All'], 'Non-CMMC Applications');
          } else {
            console.log('WARNING: Non-CMMC Applications - No data in current-week.js');
          }
          
          const timestamp = now.toISOString();
          
          let output = '// Application Completion Tracking Data\n';
          output += '// Last updated: ' + timestamp + '\n';
          output += '// Target week: ' + targetWeek + '\n';
          output += '// Cutoff: Friday at ' + CUTOFF_HOUR + ':00 UTC\n\n';
          output += '// All Applications (CMMC + Non-CMMC)\n';
          output += 'const ORG_DATA = ' + JSON.stringify(ORG_DATA, null, 4) + ';\n';
          output += '\n// CMMC Applications Data\n';
          output += 'const ORG_DATA_CMMC = ' + JSON.stringify(ORG_DATA_CMMC, null, 4) + ';\n';
          output += '\n// Non-CMMC Applications Data\n';
          output += 'const ORG_DATA_NONCMMC = ' + JSON.stringify(ORG_DATA_NONCMMC, null, 4) + ';\n';
          
          fs.writeFileSync('data.js', output, 'utf8');
          
          console.log('================================================');
          console.log('SUCCESS: data.js updated successfully');
          console.log('================================================');
          EOF
          
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data.js
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            git commit -m "Auto-update data.js - $TIMESTAMP"
            git push
            echo "Changes committed and pushed"
          fi
